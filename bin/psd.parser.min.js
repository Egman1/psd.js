/** @license psd.js 2012 - imaya [ https://github.com/imaya/psd.js ] The MIT License */
(function() {'use strict';var l=this;function m(a,b){var c=a.split("."),d=l;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)!c.length&&void 0!==b?d[e]=b:d=d[e]?d[e]:d[e]={}}function q(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};var s=void 0!==l.Uint8Array&&void 0!==l.Uint16Array&&void 0!==l.Uint32Array;function t(){}t.prototype.parse=function(a){var b;this.offset=a.ip;this.signature=u(a,4);this.key=u(a,4);b=v(a);this.length=b+12;this.data=x(a,b)};function y(){};function z(){};function A(){this.channel=[]}A.prototype.parse=function(a){var b;this.offset=a.ip;this.length=v(a)+4;if(4===this.length)window.console.log("skip: layer blending ranges(empty body)");else{b=this.offset+this.length;this.black=B(a);this.white=B(a);for(this.destRange=v(a);a.ip<b;)this.channel.push([v(a),v(a)])}};function C(){}C.prototype.parse=function(a){var b;this.offset=a.ip;b=v(a);this.length=b+4;0===b?window.console.log("skip: layer mask data (empty body)"):(this.top=D(a),this.left=D(a),this.bottom=D(a),this.right=D(a),this.defaultColor=E(a),this.flags=E(a),20===b?this.padding=B(a):(this.realFlags=E(a),this.realBackground=E(a),this.top2=D(a),this.left2=D(a),this.bottom2=D(a),this.right2=D(a)))};function F(a,b){this.input=s?new Uint8Array(a):a;this.ip=b|0}function v(a){return(a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++])>>>0}function D(a){return a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++]}function B(a){return a.input[a.ip++]<<8|a.input[a.ip++]}function G(a){return(a.input[a.ip++]<<8|a.input[a.ip++])<<16>>16}function E(a){return a.input[a.ip++]}function x(a,b){return s?a.input.subarray(a.ip,a.ip+=b):a.input.slice(a.ip,a.ip+=b)}
F.prototype.slice=function(a,b){this.ip=b;return s?this.input.subarray(a,b):this.input.slice(a,b)};F.prototype.fetch=function(a,b){return s?this.input.subarray(a,b):this.input.slice(a,b)};function u(a,b){var c=a.input,d=a.ip,e=[],f;for(f=0;f<b;++f)e[f]=String.fromCharCode(c[d++]);a.ip=d;return e.join("")}F.prototype.seek=function(a,b){"number"!==typeof b&&(b=this.ip);this.ip=b+a};
function H(a,b){var c,d,e,f=[],h=0;for(c=a.ip+b;a.ip<c;)if(d=a.input[a.ip++]<<24>>24,0>d){d=1-d;for(e=E(a);0<d--;)f[h++]=e}else for(d=1+d;0<d--;)f[h++]=E(a);return f};function I(){}I.prototype.parse=function(a){this.offset=a.ip;this.length=v(a)+4;this.overlayColorSpace=B(a);this.colorComponents=[B(a),B(a),B(a),B(a)];this.opacity=B(a);this.kind=E(a);this.filter=x(a,this.offset+this.length-a.ip);a.seek(this.offset+this.length,0)};function J(){}J.prototype.parse=function(a){this.offset=a.ip;this.signature=u(a,4);if("8BPS"!==this.signature)throw Error("invalid signature");this.version=B(a);this.reserved=x(a,6);this.channels=B(a);this.rows=v(a);this.columns=v(a);this.depth=B(a);this.colorMode=B(a);this.length=a.ip-this.offset};function K(a,b,c){this.header=a;this.colorModeData=b;this.channel=c;this.parsed=!1}
K.prototype.parse=function(){switch(this.header.colorMode){case 0:window.console.error("bitmap color mode not supported");break;case 8:window.console.warn("duotone color mode implementation is incomplete");case 1:var a=this.channel[0],b,c=a.length,d=this.redChannel=new (s?Uint8Array:Array)(c),e=this.greenChannel=new (s?Uint8Array:Array)(c),f=this.blueChannel=new (s?Uint8Array:Array)(c),h=this.header.depth/8,g;for(b=g=0;b<c;++g,b+=h)d[g]=e[g]=f[g]=a[b];break;case 2:a=this.channel[0];c=a.length;e=this.redChannel=
new (s?Uint8Array:Array)(c);f=this.greenChannel=new (s?Uint8Array:Array)(c);h=this.blueChannel=new (s?Uint8Array:Array)(c);g=this.colorModeData.data;var j=g.length/3;for(b=d=0;b<c;++d,b+=1)e[d]=g[a[b]],f[d]=g[a[b]+j],h[d]=g[a[b]+2*j];break;case 7:window.console.warn("multichannel color mode implementation is incomplete");case 3:a=this.redChannel=this.channel[0];b=this.greenChannel=this.channel[1];c=this.blueChannel=this.channel[2];e=this.header.depth/8;if(1!==e){if(4===this.channel.length){d=this.alphaChannel=
this.channel[3];f=g=0;for(h=a.length;f<h;++g,f+=e)a[g]=a[f],b[g]=b[f],c[g]=c[f],d[g]=d[f]}else{f=g=0;for(h=a.length;f<h;++g,f+=e)a[g]=a[f],b[g]=b[f],c[g]=c[f]}s?(this.redChannel=a.subarray(0,g),this.greenChannel=b.subarray(0,g),this.blueChannel=c.subarray(0,g)):a.length=b.length=c.length=g;4===this.channel.length&&(s?this.alphaChannel=d.subarray(0,g):d.length=g)}break;case 4:a=this.channel[0];b=this.channel[1];c=this.channel[2];d=this.channel[3];f=a.length;h=this.redChannel=new (s?Uint8Array:Array)(f);
g=this.greenChannel=new (s?Uint8Array:Array)(f);for(var j=this.blueChannel=new (s?Uint8Array:Array)(f),i,p,k,n,r=this.header.depth/8,w,e=w=0;e<f;++w,e+=r)i=255-a[e],p=255-b[e],k=255-c[e],n=255-d[e],h[w]=65535-(i*(255-n)+(n<<8))>>8,g[w]=65535-(p*(255-n)+(n<<8))>>8,j[w]=65535-(k*(255-n)+(n<<8))>>8;break;case 9:a=this.channel[0];b=this.channel[1];c=this.channel[2];e=a.length;f=this.redChannel=new (s?Uint8Array:Array)(e);h=this.greenChannel=new (s?Uint8Array:Array)(e);g=this.blueChannel=new (s?Uint8Array:
Array)(e);j=6/29;p=this.header.depth/8;for(d=i=0;d<e;++i,d+=p)r=((100*a[d]>>8)+16)/116,k=r+(b[d]-128)/500,n=r-(c[d]-128)/200,k=k>j?0.950456*Math.pow(k,3):3*(k-16/116)*Math.pow(j,2),r=r>j?1*Math.pow(r,3):3*(r-16/116)*Math.pow(j,2),n=n>j?1.088754*Math.pow(n,3):3*(n-16/116)*Math.pow(j,2),f[i]=255*Math.pow(2.041588*k-0.565007*r-0.344731*n,1/2.2),h[i]=255*Math.pow(-0.969244*k+1.875968*r+0.041555*n,1/2.2),g[i]=255*Math.pow(0.013444*k-0.118362*r+1.015175*n,1/2.2)}this.parsed=!0};function L(){}L.prototype.parse=function(a,b){var c;this.offset=a.ip;c=v(a);this.length=c+4;if(2===b.colorMode&&768!==c)throw Error("invalid color mode data");this.data=x(a,c)};function M(){}q(M,z);M.prototype.parse=function(a,b){var c=this.channel=[],d,e=b.channels,f=b.columns*b.rows*(b.depth/8);for(d=0;d<e;++d)c[d]=x(a,f)};function N(){}N.prototype.parse=function(a){this.offset=a.ip;if("8BIM"!==u(a,4))throw Error("invalid signature");this.identifier=B(a);this.name=u(a,a.input[a.ip++]);this.dataSize=v(a);this.data=x(a,this.dataSize);this.length=a.ip-this.offset};function O(){}O.prototype.parse=function(a){this.offset=a.ip;this.length=v(a)+4;this.imageResource=new N;this.imageResource.parse(a);a.seek(this.offset+this.length,0)};function P(){}q(P,z);P.prototype.parse=function(a,b){var c,d=this.channel=[],e=this.lineLength=[],f,h,g=b.rows,j=b.channels,i;for(c=0;c<g*j;++c)e[c]=B(a);for(f=0;f<j;++f){h=[];for(c=i=0;c<g;++c)h[c]=H(a,e[f*g+c]*(b.depth/8)),i+=h[c].length;if(s){d[f]=new Uint8Array(i);i=c=0;for(g=h.length;c<g;++c)d[f].set(h[c],i),i+=h[c].length}else d[f]=Array.prototype.concat.apply([],h)}};function Q(){}Q.prototype.parse=function(a,b){this.offset=a.ip;this.compressionMethod=B(a);switch(this.compressionMethod){case 0:this.image=new M;break;case 1:this.image=new P;break;default:throw Error("unknown compression method");}this.image.parse(a,b);this.length=a.ip-this.offset};
Q.prototype.createCanvas=function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d"),e=c.width=a.columns,f=c.height=a.rows,h,g,j,i,p,k;h=new K(a,b,this.image.channel);h.parsed||h.parse();k=[h.redChannel,h.greenChannel,h.blueChannel];if(0>=e||0>=f)return null;h=d.createImageData(e,f);g=h.data;for(i=0;i<f;++i)for(j=0;j<e;++j)p=i*e+j,g[4*p]=k[0][p],g[4*p+1]=k[1][p],g[4*p+2]=k[2][p],g[4*p+3]=255;d.putImageData(h,0,0);return c};function R(){this.info=[]}
R.prototype.parse=function(a){var b,c;this.offset=a.ip;this.top=D(a);this.left=D(a);this.bottom=D(a);this.right=D(a);this.channels=B(a);b=0;for(c=this.channels;b<c;++b)this.info[b]={id:G(a),length:v(a)};if("8BIM"!==u(a,4))throw Error("invalid blend mode signature");this.blendMode=u(a,4);this.opacity=E(a);this.clipping=E(a);this.flags=E(a);this.filter=E(a);this.extraLength=v(a);b=a.ip+this.extraLength;this.layerMaskData=new C;this.layerMaskData.parse(a);this.blendingRanges=new A;this.blendingRanges.parse(a);
c=E(a);this.name=u(a,c);a.seek((4-(1+c)%4)%4);for(this.additionalLayerInfo=[];a.ip<b;)c=new t,c.parse(a),this.additionalLayerInfo.push(c);this.length=a.ip-this.offset};function S(){}q(S,y);S.prototype.parse=function(a,b,c){this.channel=x(a,c)};function T(){}q(T,y);T.prototype.parse=function(a,b,c){var d=this.lineLength=[],e=[];b=b.bottom-b.top;var f=a.ip+c,h=0;for(c=0;c<b;++c)d[c]=B(a);for(c=0;c<b&&!(e[c]=H(a,d[c]),h+=e[c].length,a.ip>=f);++c);if(s){this.channel=new Uint8Array(h);a=c=0;for(b=e.length;c<b;++c)this.channel.set(e[c],a),a+=e[c].length}else this.channel=Array.prototype.concat.apply([],e)};function U(){}U.prototype.parse=function(a,b){var c=this.channel=[],d,e,f,h,g;this.offset=a.ip;e=0;for(f=b.channels;e<f;++e)if(h=a.ip,g=b.info[e],d=B(a),2!==g.length){switch(d){case 0:d=new S;break;case 1:d=new T;break;default:throw Error("unknown compression method: "+d);}d.parse(a,b,g.length-2);c[e]=d;a.seek(g.length+h,0)}this.length=a.ip-this.offset};
U.prototype.createCanvas=function(a,b,c){var d=document.createElement("canvas"),e=d.getContext("2d"),f=d.width=c.right-c.left,h=d.height=c.bottom-c.top,g,j,i=this.channel,p=[],k,n,r;if(0===f||0===h)return null;g=e.createImageData(f,h);j=g.data;k=0;for(n=i.length;k<n;++k)switch(c.info[k].id){case 0:case 1:case 2:case 3:p[c.info[k].id]=i[k].channel;break;case -1:r=i[k].channel;break;default:window.console.warn("not supported channel id",c.info[k].id)}r&&p.push(r);a=new K(a,b,p);a.parsed||a.parse();
i=[a.redChannel,a.greenChannel,a.blueChannel,a.alphaChannel];for(b=0;b<h;++b)for(a=0;a<f;++a)c=b*f+a,j[4*c+0]=i[0][c],j[4*c+1]=i[1][c],j[4*c+2]=i[2][c],j[4*c+3]=i[3]?i[3][c]:255;e.putImageData(g,0,0);return d};function V(){this.layerRecord=[];this.channelImageData=[]}V.prototype.parse=function(a){var b,c,d;this.offset=a.ip;this.length=v(a)+4;this.layerCount=Math.abs(G(a));b=0;for(c=this.layerCount;b<c;++b)d=new R,d.parse(a),this.layerRecord[b]=d;b=0;for(c=this.layerCount;b<c;++b)d=new U,d.parse(a,this.layerRecord[b]),this.channelImageData[b]=d;a.seek(this.offset+this.length,0)};function W(){}W.prototype.parse=function(a){var b;this.offset=a.ip;b=v(a);this.length=b+4;0===b&&window.console.log("skip: layer and mask information (empty body)");b=a.ip+b;this.layerInfo=new V;this.globalLayerMaskInfo=new I;this.additionalLayerInfo=new t;this.layerInfo.parse(a);this.globalLayerMaskInfo.parse(a);this.additionalLayerInfo.parse(a);a.seek(b,0)};function X(a,b){b||(b={});this.stream=new F(a,b.inputPosition|0)}X.prototype.parse=function(){var a=this.stream;this.header=new J;this.colorModeData=new L;this.imageResources=new O;this.layerAndMaskInformation=new W;this.imageData=new Q;this.header.parse(a);this.colorModeData.parse(a,this.header);this.imageResources.parse(a);this.layerAndMaskInformation.parse(a);this.imageData.parse(a,this.header)};m("PSD.Parser",X);m("PSD.Parser.prototype.parse",X.prototype.parse);}).call(this);
