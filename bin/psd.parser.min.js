/** @license psd.js 2012 - imaya [ https://github.com/imaya/psd.js ] The MIT License */
(function() {'use strict';var g=this;function k(a,b){var c=a.split("."),d=g;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)!c.length&&void 0!==b?d[e]=b:d=d[e]?d[e]:d[e]={}};var l=void 0!==g.Uint8Array&&void 0!==g.Uint16Array&&void 0!==g.Uint32Array;function m(){}m.prototype.parse=function(a){var b;this.offset=a.ip;this.signature=o(a,4);this.key=o(a,4);b=p(a);this.length=b+12;this.data=r(a,b)};function s(){this.channel=[]}s.prototype.parse=function(a){var b;this.offset=a.ip;this.length=p(a)+4;b=this.offset+this.length;t(a);t(a);for(p(a);a.ip<b;)this.channel.push([p(a),p(a)])};function u(){}u.prototype.parse=function(a){var b;this.offset=a.ip;b=p(a);this.length=b+4;0===b?window.console.log("skip: layer mask data (empty body)"):(this.top=v(a),this.left=v(a),this.bottom=v(a),this.right=v(a),w(a),w(a),20===b?this.padding=t(a):(w(a),w(a),v(a),v(a),v(a),v(a)))};function y(a,b){this.input=l?new Uint8Array(a):a;this.ip=b|0}function p(a){return(a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++])>>>0}function v(a){return a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++]}function t(a){return a.input[a.ip++]<<8|a.input[a.ip++]}function z(a){return(a.input[a.ip++]<<8|a.input[a.ip++])<<16>>16}function w(a){return a.input[a.ip++]}function r(a,b){return l?a.input.subarray(a.ip,a.ip+=b):a.input.slice(a.ip,a.ip+=b)}
y.prototype.slice=function(a,b){this.ip=b;return l?this.input.subarray(a,b):this.input.slice(a,b)};function o(a,b){var c=a.input,d=a.ip,e=[],f;for(f=0;f<b;++f)e[f]=String.fromCharCode(c[d++]);a.ip=d;return e.join("")}y.prototype.seek=function(a,b){"number"!==typeof b&&(b=this.ip);this.ip=b+a};function A(a,b){var c,d,e,f=[],i=0;for(c=a.ip+b;a.ip<c;)if(d=a.input[a.ip++]<<24>>24,0>d){d=1-d;for(e=w(a);0<d--;)f[i++]=e}else for(d=1+d;0<d--;)f[i++]=w(a);return f};function B(){}B.prototype.parse=function(a){this.offset=a.ip;this.length=p(a)+4;t(a);t(a);t(a);t(a);t(a);this.opacity=t(a);w(a);this.filter=r(a,this.offset+this.length-a.ip);a.seek(this.offset+this.length,0)};function C(){}C.prototype.parse=function(a){this.offset=a.ip;this.signature=o(a,4);if("8BPS"!==this.signature)throw Error("invalid signature");this.version=t(a);r(a,6);this.channels=t(a);this.rows=p(a);this.columns=p(a);this.depth=t(a);this.colorMode=t(a);this.length=a.ip-this.offset};function D(){}D.prototype.parse=function(a,b){var c;this.offset=a.ip;c=p(a);this.length=c+4;if(2===b.colorMode&&768!==c)throw Error("invalid color mode data");this.data=r(a,c)};function E(){}E.prototype.parse=function(a,b){var c=this.channel=[],d,e=b.channels,f=b.columns*b.rows;for(d=0;d<e;++d)c[d]=r(a,f)};function F(){}F.prototype.parse=function(a){this.offset=a.ip;if("8BIM"!==o(a,4))throw Error("invalid signature");this.identifier=t(a);this.name=o(a,a.input[a.ip++]);this.dataSize=p(a);this.data=r(a,this.dataSize);this.length=a.ip-this.offset};function G(){}G.prototype.parse=function(a){this.offset=a.ip;this.length=p(a)+4;this.imageResource=new F;this.imageResource.parse(a);a.seek(this.offset+this.length,0)};function H(){}H.prototype.parse=function(a,b){var c,d=this.channel=[],e=[],f,i,h=b.rows,j=b.channels;for(c=0;c<h*j;++c)e[c]=t(a);for(f=0;f<j;++f){i=[];for(c=0;c<h;++c)i[c]=A(a,e[f*h+c]);d[f]=Array.prototype.concat.apply([],i)}};function I(){}I.prototype.parse=function(a,b){this.offset=a.ip;this.compressionMethod=t(a);switch(this.compressionMethod){case 0:this.image=new E;break;case 1:this.image=new H;break;default:throw Error("unknown compression method");}this.image.parse(a,b);this.length=a.ip-this.offset};
I.prototype.createCanvas=function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=b.width=a.columns,a=b.height=a.rows,e,f,i,h,j,n=this.image.channel;if(0>=d||0>=a)return null;e=c.createImageData(d,a);f=e.data;for(h=0;h<a;++h)for(i=0;i<d;++i)j=h*d+i,f[4*j]=n[0]?n[0][j]:255,f[4*j+1]=n[1]?n[1][j]:255,f[4*j+2]=n[2]?n[2][j]:255,f[4*j+3]=n[3]?n[3][j]:255;c.putImageData(e,0,0);return b};function J(){this.info=[]}
J.prototype.parse=function(a){var b,c;this.offset=a.ip;this.top=v(a);this.left=v(a);this.bottom=v(a);this.right=v(a);this.channels=t(a);b=0;for(c=this.channels;b<c;++b)this.info[b]={id:z(a),length:p(a)};if("8BIM"!==o(a,4))throw Error("invalid blend mode signature");o(a,4);this.opacity=w(a);w(a);w(a);this.filter=w(a);this.extraLength=p(a);b=a.ip+this.extraLength;this.layerMaskData=new u;this.layerMaskData.parse(a);this.blendingRanges=new s;this.blendingRanges.parse(a);c=w(a);this.name=o(a,c);a.seek((4-
(1+c)%4)%4);for(this.additionalLayerInfo=[];a.ip<b;)c=new m,c.parse(a),this.additionalLayerInfo.push(c);this.length=a.ip-this.offset};function K(){}K.prototype.parse=function(a,b,c){this.channel=r(a,c)};function L(){}L.prototype.parse=function(a,b,c){for(var d=[],e=[],b=b.bottom-b.top,f=a.ip+c,c=0;c<b;++c)d[c]=t(a);for(c=0;c<b&&!(e[c]=A(a,d[c]),a.ip>=f);++c);this.channel=Array.prototype.concat.apply([],e)};function M(){}M.prototype.parse=function(a,b){var c=this.channel=[],d,e,f,i,h;this.offset=a.ip;e=0;for(f=b.channels;e<f;++e)if(i=a.ip,h=b.info[e],d=t(a),2!==h.length){switch(d){case 0:d=new K;break;case 1:d=new L;break;default:throw Error("unknown compression method: "+d);}d.parse(a,b,h.length-2);c[e]=d;a.seek(h.length+i,0)}this.length=a.ip-this.offset};
M.prototype.createCanvas=function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=b.width=a.right-a.left,e=b.height=a.bottom-a.top,f,i,h,j,n,O=this.channel,x,q,P;if(0===d||0===e)return null;f=c.createImageData(d,e);i=f.data;q=0;for(P=O.length;q<P;++q){switch(a.info[q].id){case 0:case 1:case 2:x=a.info[q].id;break;case -1:x=3;break;default:window.console.warn("not supported channel id",a.info[q].id);continue}for(j=0;j<e;++j)for(h=0;h<d;++h)n=j*d+h,i[4*n+x]=O[q].channel[n]}c.putImageData(f,
0,0);return b};function N(){this.layerRecord=[];this.channelImageData=[]}N.prototype.parse=function(a){var b,c,d;this.offset=a.ip;this.length=p(a)+4;this.layerCount=Math.abs(z(a));b=0;for(c=this.layerCount;b<c;++b)d=new J,d.parse(a),this.layerRecord[b]=d;b=0;for(c=this.layerCount;b<c;++b)d=new M,d.parse(a,this.layerRecord[b]),d.createCanvas(this.layerRecord[b]),this.channelImageData[b]=d;a.seek(this.offset+this.length,0)};function Q(){}Q.prototype.parse=function(a){var b;this.offset=a.ip;b=p(a);this.length=b+4;b=a.ip+b;this.layerInfo=new N;this.globalLayerMaskInfo=new B;this.additionalLayerInfo=new m;this.layerInfo.parse(a);this.globalLayerMaskInfo.parse(a);this.additionalLayerInfo.parse(a);a.seek(b,0)};function R(a,b){b||(b={});this.stream=new y(a,b.inputPosition|0)}R.prototype.parse=function(){var a=this.stream;this.header=new C;this.colorModeData=new D;this.imageResources=new G;this.layerAndMaskInformation=new Q;this.imageData=new I;this.header.parse(a);this.colorModeData.parse(a,this.header);this.imageResources.parse(a);this.layerAndMaskInformation.parse(a);this.imageData.parse(a,this.header);this.imageData.createCanvas(this.header)};k("PSD.Parser",R);k("PSD.Parser.prototype.parse",R.prototype.parse);}).call(this);
